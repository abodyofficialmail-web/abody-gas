# メール送信安定化_修正パッチ

## 目的

フォーム送信後、**数秒以内に必ずメールが送られる**ようにする（ただし **二重送信ゼロ**）。

## 変更ファイル

- `abody-gas/コード.js`

## 変更点（要約）

- **`onFormSubmit(e)`**
  - メール送信は行わない。
  - 必須チェック（送信先メール・会員）後に、`COL_STATUS` を **`送信待ち`** に設定。
  - 直後に `processPendingEmails()` を **try/catch** で呼び、即時送信を実現（失敗しても送信待ちが残る）。

- **`processPendingEmails()`（新規）**
  - **LockService（ScriptLock）を必ず使用**し、同時実行を防止。
  - 処理対象は **`送信待ち` のみ**。
  - **送信済み（`✅送信完了`）はスキップ**。
  - 処理開始前にステータスを **`処理中...`** に更新し、二重処理を防止。
  - 既存の送信ルート（`送信待ち → processPendingEmails → processRow`）を維持。

- **`processRow()`**
  - `processRow()` の複数定義を削除し、**1つに統合**。
  - 送信成功で **`✅送信完了 ...`** を記録。
  - 送信失敗で **`❌エラー：...`** を記録。

## テスト手順

### 1) フォーム送信 → 即送信

1. フォームから1件送信する
2. スプレッドシートの `COL_STATUS` が一瞬 `送信待ち` → `処理中...` に変わり、数秒以内に **`✅送信完了 ...`** になる
3. 対象メールアドレスにメールが届く

### 2) 二重送信しない

- 同じタイミングで複数送信、もしくはトリガーが並行して動く状況でも、Lock + `処理中...` への先更新により **同一行が二重送信されない**ことを確認する

### 3) 送信待ち残りを時間トリガーで拾える

1. 何らかの理由で即時実行が失敗しても、`COL_STATUS` が `送信待ち` のまま残ることを確認
2. 時間主導トリガーで `processPendingEmails()` を実行し、残件が **`✅送信完了 ...`** になることを確認

